var le=Object.defineProperty;var te=Object.getOwnPropertySymbols;var ce=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var ue=(s,e,o)=>e in s?le(s,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[e]=o;var oe=(s,e)=>{var o={};for(var a in s)ce.call(s,a)&&e.indexOf(a)<0&&(o[a]=s[a]);if(s!=null&&te)for(var a of te(s))e.indexOf(a)<0&&de.call(s,a)&&(o[a]=s[a]);return o};var z=(s,e,o)=>(ue(s,typeof e!="symbol"?e+"":e,o),o);import{r as y,j as k,A as fe,a as r,L as he,M as pe,B as me,T as W,b as F,P as ye,F as Z,c as j,C as K,d as ge,I as xe,S as ve,e as X,f as se,g as be,h as we,R as Me,i as Se,k as Ie,l as ke}from"./vendor.e8bb4d27.js";const Re=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const t of n)if(t.type==="childList")for(const p of t.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&a(p)}).observe(document,{childList:!0,subtree:!0});function o(n){const t={};return n.integrity&&(t.integrity=n.integrity),n.referrerpolicy&&(t.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?t.credentials="include":n.crossorigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(n){if(n.ep)return;n.ep=!0;const t=o(n);fetch(n.href,t)}};Re();const De=()=>{const[s,e]=y.exports.useState(!1);return y.exports.useEffect(()=>{const o=!!window.showDirectoryPicker;e(!o)},[]),s?k(fe,{severity:"error",children:["This tool requires browser support for ",r("code",{children:"window.showDirectoryPicker"}),"."," ",r(he,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Window/showDirectoryPicker#browser_compatibility",children:"Check compatibility on MDN"})]}):null},H=()=>{throw new Error("Invalid invocation outside of AppContext!")},re=y.exports.createContext({actions:{deleteMapData:H,loadMapData:H,selectRegion:H,unselectRegion:H,setIsSafeHouseProtectionEnabled:H,setSafeHousePadding:H,setZoomLevel:H,toggleMap:H},state:{excludedRegions:[],isMapDisplayed:!0,isSafeHouseProtectionEnabled:!0,isSelectionInverted:!1,mapData:[],safeHousePadding:4,safeHouses:[],selection:void 0,zoomLevel:1}}),q=()=>y.exports.useContext(re);class Ce{constructor(e){z(this,"_byteOffset");z(this,"_dataView");z(this,"_markedByteOffset");this._dataView=new DataView(e),this._byteOffset=0}get position(){return this._byteOffset}mark(){this._markedByteOffset=this._byteOffset}readBytes(e){const o=[];for(let a=0;a<e;a++)o.push(this.readInt8());return o}readFloat32(){const e=this._dataView.getFloat32(this._byteOffset);return this._byteOffset+=4,e}readInt16(){const e=this._dataView.getInt16(this._byteOffset);return this._byteOffset+=2,e}readInt32(){const e=this._dataView.getInt32(this._byteOffset);return this._byteOffset+=4,e}readInt8(){return this._dataView.getInt8(this._byteOffset++)}readInt8Array(e){return new Int8Array(this.readBytes(e))}readString(e){e==null&&(e=this.readInt16());const o=this.readBytes(e).map(n=>String.fromCharCode(n)).join(""),a=o.indexOf("\0");return a>-1?o.slice(0,a):o}readUint8(){return this._dataView.getUint8(this._byteOffset++)}reset(){this._markedByteOffset?(this._byteOffset=this._markedByteOffset,delete this._markedByteOffset):this._byteOffset=0}skipBytes(e){this._byteOffset+=e}}const ne=(s,e)=>{const[o,a]=e;return o.x<=s.x&&s.x<a.x&&o.y<=s.y&&s.y<a.y},U=(s,e,o,a)=>{for(const t of a)if(ne(s,t))return!1;let n=ne(s,e);return o&&(n=!n),n},Pe=(s,e)=>{const o=[[],[]];return s.forEach(a=>{o[e(a)?0:1].push(a)}),o},Ee=(s,e,o,a,n)=>{const[t,p]=Pe(e,b=>U(b,o,a,n)),f=t.map(({x:b,y:i})=>`map_${b}_${i}.bin`),S=Promise.all(f.map(b=>s.removeEntry(b))).then(()=>{});return[p,S]},ae=(s,e)=>{const[{x:o,y:a},{x:n,y:t}]=s;return[{x:o-e,y:a-e},{x:n+e,y:t+e}]},ie=(s,e)=>s.parentElement===e?!0:s.parentElement?ie(s.parentElement,e):!1,_e=async s=>{const e=[],o=new RegExp(/map_(\d+)_(\d+).bin/);for await(const a of s.keys()){const n=o.exec(a);if(n){const[t,p,f]=n;e.push({x:parseInt(p),y:parseInt(f)})}}return e},He=s=>new Promise((e,o)=>{const a=new FileReader;a.onload=n=>{var p;const t=(p=n.target)==null?void 0:p.result;t instanceof ArrayBuffer&&e(t),o(new Error("Invalid return type!"))},a.onerror=n=>{o(n)},a.readAsArrayBuffer(s)}),Be=async s=>{const e=[],a=await(await s.getFileHandle("map_meta.bin")).getFile(),n=await He(a),t=new Ce(n);t.mark();const p=t.readString(4);let f=0;if(p==="META"?f=t.readInt32():(f=33,t.reset()),f<194)throw new Error(`File version ${f} not supported!`);const S=t.readInt32(),b=t.readInt32(),i=t.readInt32(),_=t.readInt32();for(let R=S;R<=i;R++)for(let v=b;v<=_;v++){const u=t.readInt32();for(let l=0;l<u;l++)f<194?t.skipBytes(4):t.skipBytes(8),f>=160?t.skipBytes(2):(t.skipBytes(1),f>=34&&t.skipBytes(1));const d=t.readInt32();for(let l=0;l<d;l++)f>=194&&t.skipBytes(8),t.skipBytes(1),f>=57&&t.skipBytes(4),f>=74&&t.skipBytes(1),f>=107&&t.skipBytes(1),f>=111&&f<121&&t.skipBytes(4),f>=125&&t.skipBytes(4)}if(f<=112)throw new Error("Zones not supported!");const E=t.readInt32();for(let R=0;R<E;R++){const v=t.readInt32(),u=t.readInt32(),d=t.readInt32(),l=t.readInt32(),h=t.readString(),g=t.readInt32(),D=[];for(let x=0;x<g;x++){const M=t.readString();D.push(M)}t.skipBytes(8);let c=`${h}'s safe house`;if(f>=101&&(c=t.readString()),f>=177){const x=t.readInt32();for(let M=0;M<x;M++)t.readString()}e.push({region:[{x:Math.floor(v/10),y:Math.floor(u/10)},{x:Math.ceil((v+d)/10),y:Math.ceil((u+l)/10)}],owner:h,players:D,title:c})}return e},Le=s=>{const{isModalOpen:e=!1,onClose:o}=s,{actions:{deleteMapData:a},state:{isSelectionInverted:n,mapData:t,selection:p,excludedRegions:f}}=q(),S=y.exports.useMemo(()=>p?t.filter(b=>U(b,p,n,f)).length:0,[t,p,n]);return r(pe,{open:e,onClose:()=>o==null?void 0:o(),onMouseDownCapture:b=>{b.nativeEvent.stopImmediatePropagation(),b.nativeEvent.stopPropagation()},onMouseUpCapture:b=>{b.nativeEvent.stopImmediatePropagation(),b.nativeEvent.stopPropagation()},children:k(me,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:400,bgcolor:"background.paper",border:"2px solid #000",boxShadow:24,p:4},children:[r(W,{variant:"h6",component:"h2",children:"Delete?"}),k(W,{sx:{mt:2},children:["Are you sure you would like to delete ",S," chunk",S>1?"s":"","?"]}),r(W,{sx:{mt:2},children:"This action is not reversible! Make sure you back up your save folder before proceeding!"}),r(F,{color:"error",variant:"contained",sx:{mt:2},onClick:()=>{if(!S){o==null||o(),console.error("");return}a(),o==null||o()},children:"Delete forever!"}),r(F,{style:{marginLeft:16},sx:{mt:2},onClick:()=>{o==null||o()},children:"Cancel"})]})})},V=100,Oe=()=>{const{actions:{selectRegion:s,unselectRegion:e},state:{excludedRegions:o,isMapDisplayed:a,isSafeHouseProtectionEnabled:n,isSelectionInverted:t,mapData:p,safeHouses:f,safeHousePadding:S,selection:b,zoomLevel:i}}=q(),_=y.exports.useRef(null),E=y.exports.useRef(null),R=y.exports.useRef(null),v=y.exports.useMemo(()=>{let u=0,d=0,l=2e4,h=2e4;for(const{x:c,y:x}of p)u=Math.max(c,u),d=Math.max(x,d),l=Math.min(c,l),h=Math.min(x,h);u+=V,d+=V,l-=V,h-=V;const g=[];for(let c=Math.floor(h/100);c<=Math.floor(d/100);c++)for(let x=Math.floor(l/100);x<=Math.floor(u/100);x++)g.push(`${x}_${c}`);const D=Math.floor(u/100)-Math.floor(l/100)+1;return{maxX:u,maxY:d,minX:l,minY:h,tiles:g,columnCount:D}},[p]);return y.exports.useEffect(()=>{const u=E.current,d=R.current;if(!u||!d)return;const l=u.getContext("2d");if(!l)return;const{maxX:h,maxY:g,minX:D,minY:c}=v,x=Math.max(1,(h-D)*i),M=Math.max(1,(g-c)*i);d.width=u.width=x,d.height=u.height=M,l.fillStyle="hsla(0, 0%, 10%, 0)",l.fillRect(0,0,x,M);const B=(m,w,I,C)=>{l.fillRect((m-D)*i,(w-c)*i,I*i,C*i)},L=m=>{const[{x:w,y:I},{x:C,y:P}]=m;B(w,I,C-w,P-I)},$=(m,w)=>{const ee=l.measureText(w),{width:I}=ee,C=oe(ee,["width"]),[{x:P,y:O},{x:A}]=m,Y=A-P,T=P+Y/2-I/i/2,N=4,G=8,J=O,Q=-8;l.fillStyle="rgba(0, 0, 0, 0.3)",l.fillRect((T-D)*i-N,(J-c)*i-G-N+Q,I+N*2,G+N*2),l.fillStyle="#fff",l.fillText(w,(T-D)*i,(J-c)*i+Q)};for(const m of p){const w=b&&U(m,b,t,o);l.fillStyle=w?"hsla(0, 100%, 76%, 70%)":"hsla(41, 49%, 76%, 70%)",B(m.x,m.y,1,1)}if(n)for(const m of f){const{region:w,owner:I}=m,C=`${I}'s safehouse`;l.fillStyle="hsla(100, 100%, 76%, 70%)",L(w);const P=ae(w,S);l.fillStyle="hsla(100, 100%, 76%, 40%)",L(P),$(P,C)}},[p,v,n,S,f,b,t,i,o]),y.exports.useEffect(()=>{const u=R.current;if(!u)return;const d=u.getContext("2d");if(!d)return;let l={x:0,y:0},h,g;const{minX:D,minY:c}=v,x=m=>{const w=u.getBoundingClientRect(),I=m.clientX-Math.floor(w.left),C=m.clientY-Math.floor(w.top);return{x:Math.floor(I/i+D),y:Math.floor(C/i+c)}},M=()=>{const m=l.x,w=l.y;if(d.clearRect(0,0,u.width,u.height),h){const C=h.x,P=h.y,O=(C-D)*i,A=(P-c)*i,Y=(m-C)*i,T=(w-P)*i;d.fillStyle="#f664",g?(d.fillRect(0,0,u.width,u.height),d.clearRect(O,A,Y,T)):d.fillRect(O,A,Y,T),d.strokeStyle="#f66c",d.strokeRect(O,A,Y,T)}d.fillStyle="rgba(0, 0, 0, 0.3)";const{width:I}=d.measureText(`X: ${m} Y: ${w}`);d.fillRect(0,0,I+12,18),d.fillStyle="#fff",d.fillText(`X: ${m} Y: ${w}`,4,12)},B=m=>{l=x(m),M()},L=m=>{m.button===0&&(!(m.target instanceof HTMLElement)||!_.current||!ie(m.target,_.current)||(m.preventDefault(),h=x(m),g=m.ctrlKey,e(),M()))},$=m=>{if(m.button!==0||!h)return;m.preventDefault();const w=l.x,I=l.y,C=h.x,P=h.y,O={x:Math.min(w,C),y:Math.min(I,P)},A={x:Math.max(w,C),y:Math.max(I,P)};h=void 0,M(),s([O,A],g)};return document.body.addEventListener("mousemove",B),document.body.addEventListener("mousedown",L),document.body.addEventListener("mouseup",$),M(),()=>{document.body.removeEventListener("mousemove",B),document.body.removeEventListener("mousedown",L),document.body.removeEventListener("mouseup",$)}},[v,s,e,i]),p.length?r(ye,{style:{padding:"1rem",userSelect:"none"},children:k("div",{ref:_,style:{display:p.length>0?"grid":"none",contain:"paint",overflow:"auto",maxHeight:"80vh",maxWidth:"80vw"},children:[a&&r("div",{style:{width:i*(v.maxX-v.minX),height:i*(v.maxY-v.minY),overflow:"hidden",gridArea:"1 / 1",backgroundColor:"rgba(0,0,0,0.2)"},children:r("div",{style:{marginLeft:i*-(v.minX%100),marginTop:i*-(v.minY%100),display:"grid",gridTemplateColumns:`repeat(${v.columnCount}, ${i*100}px)`,zIndex:0},children:v.tiles.map(u=>r("img",{className:"tile",src:`./assets/map_${u}.png`,onLoad:d=>{d.currentTarget.classList.add("loaded")},width:i*100,height:i*100,loading:"lazy"},u))})}),r("canvas",{ref:E,style:{zIndex:1,gridArea:"1 / 1",backgroundColor:a?void 0:"hsla(41, 30%, 61%, 1)"}}),r("canvas",{ref:R,style:{zIndex:2,gridArea:"1 / 1"}})]})}):null},Ae=s=>{const{onDelete:e}=s,{actions:{loadMapData:o,setZoomLevel:a,toggleMap:n,setIsSafeHouseProtectionEnabled:t,setSafeHousePadding:p},state:{isMapDisplayed:f,isSelectionInverted:S,mapData:b,selection:i,zoomLevel:_,isSafeHouseProtectionEnabled:E,excludedRegions:R,safeHousePadding:v}}=q(),[u,d]=y.exports.useState(!0),l=y.exports.useMemo(()=>i?b.filter(h=>U(h,i,S,R)).length:0,[b,i,S,R]);return k(Z,{children:[k("div",{style:{display:"flex",gap:16,width:1200},children:[r(F,{variant:"contained",onClick:()=>o(),children:"Load map data"}),k(F,{variant:"contained",color:"error",disabled:l===0,onClick:()=>e==null?void 0:e(),children:["Delete ",l," chunks"]}),r("div",{className:"spacer"}),r(j,{control:r(K,{checked:f,onChange:(h,g)=>n(g)}),label:"Overlay Knox Country"}),r(j,{control:r(K,{checked:E,onChange:(h,g)=>t(g)}),label:"Protect Safehouses"}),r(j,{control:r(K,{checked:u,onChange:(h,g)=>d(g)}),label:"Show Guide"}),k(ge,{children:[r(xe,{id:"zoom-level-label",children:"Zoom level"}),k(ve,{labelId:"zoom-level-label",id:"zoom-level",value:_,label:"Zoom level",onChange:h=>{const{value:g}=h.target;typeof g=="number"&&a(g)},children:[r(X,{value:.5,children:"50%"}),r(X,{value:1,children:"100%"}),r(X,{value:2,children:"200%"}),r(X,{value:4,children:"400%"}),r(X,{value:8,children:"800%"})]})]})]}),r(se,{in:E,children:r(be,{label:"Safehouse padding",type:"number",value:v,onChange:h=>{let g=parseInt(h.target.value,10);isNaN(g)||(g=Math.max(0,g),p(g))}})}),r(se,{in:u,children:k("ul",{children:[k("li",{children:["Load your save folder, usually: ",r("code",{children:"C:\\Users\\YourName\\Zomboid\\Saves\\Survivor\\21-01-2022_12-36-36"})]}),r("li",{children:"Drag with the mouse to create a selection"}),k("li",{children:["Hold ",r("code",{children:"Ctrl"})," before selecting a region to invert it"]})]})})]})},Te=()=>k(Z,{children:[r("div",{className:"spacer"}),r("div",{className:"coffee",children:r(F,{style:{backgroundColor:"transparent",padding:0,borderRadius:8},href:"https://www.buymeacoffee.com/grabofus",children:r("img",{alt:"Buy me a coffee",width:"200",src:"./assets/coffee.png"})})})]}),Ye=()=>{const[s,e]=y.exports.useState(!1);return k(Z,{children:[r(De,{}),r("div",{style:{display:"grid",gap:16},children:r(Ae,{onDelete:()=>e(!0)})}),r("div",{children:r(Oe,{})}),r(Te,{}),r(Le,{isModalOpen:s,onClose:()=>e(!1)})]})},Xe=s=>{const e=y.exports.useRef(),[o,a]=y.exports.useState(!0),[n,t]=y.exports.useState(void 0),[p,f]=y.exports.useState([]),[S,b]=y.exports.useState(1),[i,_]=y.exports.useState(!0),[E,R]=y.exports.useState([]),[v,u]=y.exports.useState(4),d=y.exports.useRef(),l=y.exports.useMemo(()=>i?E.map(({region:c})=>ae(c,v)):[],[i,v,E]);d.current={mapData:p,selectionInfo:n,excludedRegions:l};const h=y.exports.useMemo(()=>({deleteMapData:()=>{if(!d.current)throw new Error("Something went wrong!");const{excludedRegions:c,mapData:x,selectionInfo:M}=d.current;if(!e.current)return console.error("No directory handle found! Cannot delete map files!"),[x,Promise.resolve()];if(!M)return[x,Promise.resolve()];const[B,L]=Ee(e.current,x,M.selection,M.isSelectionInverted,c);L.then(()=>{f(B)})},loadMapData:async()=>{e.current=await window.showDirectoryPicker();const c=await _e(e.current),x=await Be(e.current).catch(M=>(console.error("Failed to load safe houses! Please raise an issue on Please raise an issue at https://github.com/grabofus/zomboid-chunk-cleaner/issues",M),[]));f(c),R(x)},selectRegion:(c,x)=>{t({selection:c,isSelectionInverted:x!=null?x:!1})},unselectRegion:()=>{t(void 0)},setIsSafeHouseProtectionEnabled:c=>{_(c)},setSafeHousePadding:c=>{u(c)},setZoomLevel:c=>{b(c)},toggleMap:c=>{a(c)}}),[]);y.exports.useEffect(()=>{!!e.current},[]);const g=y.exports.useMemo(()=>{var c;return{excludedRegions:l,isMapDisplayed:o,isSafeHouseProtectionEnabled:i,isSelectionInverted:(c=n==null?void 0:n.isSelectionInverted)!=null?c:!1,mapData:p,safeHouses:E,safeHousePadding:v,selection:n==null?void 0:n.selection,zoomLevel:S}},[o,i,p,v,E,n,S]),D=y.exports.useMemo(()=>({actions:h,state:g}),[h,g]);return r(re.Provider,{value:D,children:s.children})};const Fe=we({palette:{mode:"dark",background:{default:"#000"}}});Me.render(r(Se.StrictMode,{children:r(Xe,{children:r(Ie,{theme:Fe,children:k(Z,{children:[r(ke,{}),r(Ye,{})]})})})}),document.getElementById("root"));
