var le=Object.defineProperty;var te=Object.getOwnPropertySymbols;var ce=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var ue=(n,e,o)=>e in n?le(n,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[e]=o;var oe=(n,e)=>{var o={};for(var r in n)ce.call(n,r)&&e.indexOf(r)<0&&(o[r]=n[r]);if(n!=null&&te)for(var r of te(n))e.indexOf(r)<0&&de.call(n,r)&&(o[r]=n[r]);return o};var z=(n,e,o)=>(ue(n,typeof e!="symbol"?e+"":e,o),o);import{r as y,j as C,A as fe,a,L as he,M as pe,B as me,T as U,b as V,P as ye,F as K,c as W,C as j,d as xe,I as ge,S as ve,e as X,f as ne,g as be,h as we,R as Me,i as Se,k as Ie,l as ke}from"./vendor.e8bb4d27.js";const Re=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const t of s)if(t.type==="childList")for(const p of t.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&r(p)}).observe(document,{childList:!0,subtree:!0});function o(s){const t={};return s.integrity&&(t.integrity=s.integrity),s.referrerpolicy&&(t.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?t.credentials="include":s.crossorigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function r(s){if(s.ep)return;s.ep=!0;const t=o(s);fetch(s.href,t)}};Re();const De=()=>{const[n,e]=y.exports.useState(!1);return y.exports.useEffect(()=>{const o=!!window.showDirectoryPicker;e(!o)},[]),n?C(fe,{severity:"error",children:["This tool requires browser support for ",a("code",{children:"window.showDirectoryPicker"}),"."," ",a(he,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Window/showDirectoryPicker#browser_compatibility",children:"Check compatibility on MDN"})]}):null},H=()=>{throw new Error("Invalid invocation outside of AppContext!")},re=y.exports.createContext({actions:{deleteMapData:H,loadMapData:H,selectRegion:H,unselectRegion:H,setIsSafeHouseProtectionEnabled:H,setSafeHousePadding:H,setZoomLevel:H,toggleMap:H},state:{excludedRegions:[],isMapDisplayed:!0,isSafeHouseProtectionEnabled:!0,isSelectionInverted:!1,mapData:[],safeHousePadding:4,safeHouses:[],selection:void 0,zoomLevel:1}}),q=()=>y.exports.useContext(re);class Ce{constructor(e){z(this,"_byteOffset");z(this,"_dataView");z(this,"_markedByteOffset");this._dataView=new DataView(e),this._byteOffset=0}get position(){return this._byteOffset}mark(){this._markedByteOffset=this._byteOffset}readBytes(e){const o=[];for(let r=0;r<e;r++)o.push(this.readInt8());return o}readFloat32(){const e=this._dataView.getFloat32(this._byteOffset);return this._byteOffset+=4,e}readInt16(){const e=this._dataView.getInt16(this._byteOffset);return this._byteOffset+=2,e}readInt32(){const e=this._dataView.getInt32(this._byteOffset);return this._byteOffset+=4,e}readInt8(){return this._dataView.getInt8(this._byteOffset++)}readInt8Array(e){return new Int8Array(this.readBytes(e))}readString(e){e==null&&(e=this.readInt16());const o=this.readBytes(e).map(s=>String.fromCharCode(s)).join(""),r=o.indexOf("\0");return r>-1?o.slice(0,r):o}readUint8(){return this._dataView.getUint8(this._byteOffset++)}reset(){this._markedByteOffset?(this._byteOffset=this._markedByteOffset,delete this._markedByteOffset):this._byteOffset=0}skipBytes(e){this._byteOffset+=e}}const se=(n,e)=>{const[o,r]=e;return o.x<=n.x&&n.x<r.x&&o.y<=n.y&&n.y<r.y},Z=(n,e,o,r)=>{for(const t of r)if(se(n,t))return!1;let s=se(n,e);return o&&(s=!s),s},Pe=(n,e)=>{const o=[[],[]];return n.forEach(r=>{o[e(r)?0:1].push(r)}),o},Ee=(n,e,o,r,s)=>{const[t,p]=Pe(e,b=>Z(b,o,r,s)),f=t.map(({x:b,y:i})=>`map_${b}_${i}.bin`),S=Promise.all(f.map(b=>n.removeEntry(b))).then(()=>{});return[p,S]},ae=(n,e)=>{const[{x:o,y:r},{x:s,y:t}]=n;return[{x:o-e,y:r-e},{x:s+e,y:t+e}]},ie=(n,e)=>n.parentElement===e?!0:n.parentElement?ie(n.parentElement,e):!1,_e=async n=>{const e=[],o=new RegExp(/map_(\d+)_(\d+).bin/);for await(const r of n.keys()){const s=o.exec(r);if(s){const[t,p,f]=s;e.push({x:parseInt(p),y:parseInt(f)})}}return e},He=n=>new Promise((e,o)=>{const r=new FileReader;r.onload=s=>{var p;const t=(p=s.target)==null?void 0:p.result;t instanceof ArrayBuffer&&e(t),o(new Error("Invalid return type!"))},r.onerror=s=>{o(s)},r.readAsArrayBuffer(n)}),Be=async n=>{const e=[],r=await(await n.getFileHandle("map_meta.bin")).getFile(),s=await He(r),t=new Ce(s);t.mark();const p=t.readString(4);let f=0;if(p==="META"?f=t.readInt32():(f=33,t.reset()),f<194)throw new Error(`File version ${f} not supported!`);const S=t.readInt32(),b=t.readInt32(),i=t.readInt32(),_=t.readInt32();for(let k=S;k<=i;k++)for(let v=b;v<=_;v++){const u=t.readInt32();for(let l=0;l<u;l++)f<194?t.skipBytes(4):t.skipBytes(8),f>=160?t.skipBytes(2):(t.skipBytes(1),f>=34&&t.skipBytes(1));const d=t.readInt32();for(let l=0;l<d;l++)f>=194&&t.skipBytes(8),t.skipBytes(1),f>=57&&t.skipBytes(4),f>=74&&t.skipBytes(1),f>=107&&t.skipBytes(1),f>=111&&f<121&&t.skipBytes(4),f>=125&&t.skipBytes(4)}if(f<=112)throw new Error("Zones not supported!");const E=t.readInt32();for(let k=0;k<E;k++){const v=t.readInt32(),u=t.readInt32(),d=t.readInt32(),l=t.readInt32(),h=t.readString(),x=t.readInt32(),R=[];for(let g=0;g<x;g++){const M=t.readString();R.push(M)}t.skipBytes(8);let c=`${h}'s safe house`;if(f>=101&&(c=t.readString()),f>=177){const g=t.readInt32();for(let M=0;M<g;M++)t.readString()}e.push({region:[{x:Math.floor(v/10),y:Math.floor(u/10)},{x:Math.ceil((v+d)/10),y:Math.ceil((u+l)/10)}],owner:h,players:R,title:c})}return e},Le=n=>{const{isModalOpen:e=!1,onClose:o}=n,{actions:{deleteMapData:r},state:{isSelectionInverted:s,mapData:t,selection:p,excludedRegions:f}}=q(),S=y.exports.useMemo(()=>p?t.filter(b=>Z(b,p,s,f)).length:0,[t,p,s]);return a(pe,{open:e,onClose:()=>o==null?void 0:o(),onMouseDownCapture:b=>{b.nativeEvent.stopImmediatePropagation(),b.nativeEvent.stopPropagation()},onMouseUpCapture:b=>{b.nativeEvent.stopImmediatePropagation(),b.nativeEvent.stopPropagation()},children:C(me,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:400,bgcolor:"background.paper",border:"2px solid #000",boxShadow:24,p:4},children:[a(U,{variant:"h6",component:"h2",children:"Delete?"}),C(U,{sx:{mt:2},children:["Are you sure you would like to delete ",S," chunk",S>1?"s":"","?"]}),a(U,{sx:{mt:2},children:"This action is not reversible! Make sure you back up your save folder before proceeding!"}),a(V,{color:"error",variant:"contained",sx:{mt:2},onClick:()=>{if(!S){o==null||o(),console.error("");return}r(),o==null||o()},children:"Delete forever!"}),a(V,{style:{marginLeft:16},sx:{mt:2},onClick:()=>{o==null||o()},children:"Cancel"})]})})},N=100,Oe=()=>{const{actions:{selectRegion:n,unselectRegion:e},state:{excludedRegions:o,isMapDisplayed:r,isSafeHouseProtectionEnabled:s,isSelectionInverted:t,mapData:p,safeHouses:f,safeHousePadding:S,selection:b,zoomLevel:i}}=q(),_=y.exports.useRef(null),E=y.exports.useRef(null),k=y.exports.useRef(null),v=y.exports.useMemo(()=>{let u=0,d=0,l=2e4,h=2e4;for(const{x:c,y:g}of p)u=Math.max(c,u),d=Math.max(g,d),l=Math.min(c,l),h=Math.min(g,h);u+=N,d+=N,l-=N,h-=N;const x=[];for(let c=Math.floor(h/100);c<=Math.floor(d/100);c++)for(let g=Math.floor(l/100);g<=Math.floor(u/100);g++)x.push(`${g}_${c}`);const R=Math.floor(u/100)-Math.floor(l/100)+1;return{maxX:u,maxY:d,minX:l,minY:h,tiles:x,columnCount:R}},[p]);return y.exports.useEffect(()=>{const u=E.current,d=k.current;if(!u||!d)return;const l=u.getContext("2d");if(!l)return;const{maxX:h,maxY:x,minX:R,minY:c}=v,g=Math.max(1,(h-R)*i),M=Math.max(1,(x-c)*i);d.width=u.width=g,d.height=u.height=M,l.fillStyle="hsla(0, 0%, 10%, 0)",l.fillRect(0,0,g,M);const B=(m,w,I,D)=>{l.fillRect((m-R)*i,(w-c)*i,I*i,D*i)},L=m=>{const[{x:w,y:I},{x:D,y:P}]=m;B(w,I,D-w,P-I)},F=(m,w)=>{const ee=l.measureText(w),{width:I}=ee,D=oe(ee,["width"]),[{x:P,y:O},{x:A}]=m,Y=A-P,T=P+Y/2-I/i/2,$=4,G=8,J=O,Q=-8;l.fillStyle="rgba(0, 0, 0, 0.3)",l.fillRect((T-R)*i-$,(J-c)*i-G-$+Q,I+$*2,G+$*2),l.fillStyle="#fff",l.fillText(w,(T-R)*i,(J-c)*i+Q)};for(const m of p){const w=b&&Z(m,b,t,o);l.fillStyle=w?"hsla(0, 100%, 76%, 70%)":"hsla(41, 49%, 76%, 70%)",B(m.x,m.y,1,1)}if(s)for(const m of f){const{region:w,owner:I}=m,D=`${I}'s safehouse`;l.fillStyle="hsla(100, 100%, 76%, 70%)",L(w);const P=ae(w,S);l.fillStyle="hsla(100, 100%, 76%, 40%)",L(P),F(P,D)}},[p,v,s,S,f,b,t,i,o]),y.exports.useEffect(()=>{const u=k.current;if(!u)return;const d=u.getContext("2d");if(!d)return;let l={x:0,y:0},h,x;const{minX:R,minY:c}=v,g=m=>{const w=u.getBoundingClientRect(),I=m.clientX-Math.floor(w.left),D=m.clientY-Math.floor(w.top);return{x:Math.floor(I/i+R),y:Math.floor(D/i+c)}},M=()=>{const m=l.x,w=l.y;if(d.clearRect(0,0,u.width,u.height),h){const D=h.x,P=h.y,O=(D-R)*i,A=(P-c)*i,Y=(m-D)*i,T=(w-P)*i;d.fillStyle="#f664",x?(d.fillRect(0,0,u.width,u.height),d.clearRect(O,A,Y,T)):d.fillRect(O,A,Y,T),d.strokeStyle="#f66c",d.strokeRect(O,A,Y,T)}d.fillStyle="rgba(0, 0, 0, 0.3)";const{width:I}=d.measureText(`X: ${m} Y: ${w}`);d.fillRect(0,0,I+12,18),d.fillStyle="#fff",d.fillText(`X: ${m} Y: ${w}`,4,12)},B=m=>{l=g(m),M()},L=m=>{m.button===0&&(!(m.target instanceof HTMLElement)||!_.current||!ie(m.target,_.current)||(m.preventDefault(),h=g(m),x=m.ctrlKey,e(),M()))},F=m=>{if(m.button!==0||!h)return;m.preventDefault();const w=l.x,I=l.y,D=h.x,P=h.y,O={x:Math.min(w,D),y:Math.min(I,P)},A={x:Math.max(w,D),y:Math.max(I,P)};h=void 0,M(),n([O,A],x)};return document.body.addEventListener("mousemove",B),document.body.addEventListener("mousedown",L),document.body.addEventListener("mouseup",F),M(),()=>{document.body.removeEventListener("mousemove",B),document.body.removeEventListener("mousedown",L),document.body.removeEventListener("mouseup",F)}},[v,n,e,i]),p.length?a(ye,{style:{padding:"1rem",userSelect:"none"},children:C("div",{ref:_,style:{display:p.length>0?"grid":"none",contain:"paint",overflow:"auto",maxHeight:"80vh",maxWidth:"80vw"},children:[r&&a("div",{style:{width:i*(v.maxX-v.minX),height:i*(v.maxY-v.minY),overflow:"hidden",gridArea:"1 / 1",backgroundColor:"rgba(0,0,0,0.2)"},children:a("div",{style:{marginLeft:i*-(v.minX%100),marginTop:i*-(v.minY%100),display:"grid",gridTemplateColumns:`repeat(${v.columnCount}, ${i*100}px)`,zIndex:0},children:v.tiles.map(u=>a("img",{className:"tile",src:`./assets/map_${u}.png`,onLoad:d=>{d.currentTarget.classList.add("loaded")},width:i*100,height:i*100,loading:"lazy"},u))})}),a("canvas",{ref:E,style:{zIndex:1,gridArea:"1 / 1",backgroundColor:r?void 0:"hsla(41, 30%, 61%, 1)"}}),a("canvas",{ref:k,style:{zIndex:2,gridArea:"1 / 1"}})]})}):null},Ae=n=>{const{onDelete:e}=n,{actions:{loadMapData:o,setZoomLevel:r,toggleMap:s,setIsSafeHouseProtectionEnabled:t,setSafeHousePadding:p},state:{isMapDisplayed:f,isSelectionInverted:S,mapData:b,selection:i,zoomLevel:_,isSafeHouseProtectionEnabled:E,excludedRegions:k,safeHousePadding:v}}=q(),[u,d]=y.exports.useState(!0),l=y.exports.useMemo(()=>i?b.filter(h=>Z(h,i,S,k)).length:0,[b,i,S,k]);return C(K,{children:[C("div",{style:{display:"flex",gap:16,width:1200},children:[a(V,{variant:"contained",onClick:()=>o(),children:"Load map data"}),C(V,{variant:"contained",color:"error",disabled:l===0,onClick:()=>e==null?void 0:e(),children:["Delete ",l," chunks"]}),a("div",{className:"spacer"}),a(W,{control:a(j,{checked:f,onChange:(h,x)=>s(x)}),label:"Overlay Knox Country"}),a(W,{control:a(j,{checked:E,onChange:(h,x)=>t(x)}),label:"Protect Safehouses"}),a(W,{control:a(j,{checked:u,onChange:(h,x)=>d(x)}),label:"Show Guide"}),C(xe,{children:[a(ge,{id:"zoom-level-label",children:"Zoom level"}),C(ve,{labelId:"zoom-level-label",id:"zoom-level",value:_,label:"Zoom level",onChange:h=>{const{value:x}=h.target;typeof x=="number"&&r(x)},children:[a(X,{value:.5,children:"50%"}),a(X,{value:1,children:"100%"}),a(X,{value:2,children:"200%"}),a(X,{value:4,children:"400%"}),a(X,{value:8,children:"800%"})]})]})]}),a(ne,{in:E,children:a(be,{label:"Safehouse padding",type:"number",value:v,onChange:h=>{let x=parseInt(h.target.value,10);isNaN(x)||(x=Math.max(0,x),p(x))}})}),a(ne,{in:u,children:C("ul",{children:[C("li",{children:["Load your save folder, usually: ",a("code",{children:"C:\\Users\\YourName\\Zomboid\\Saves\\Survivor\\21-01-2022_12-36-36"})]}),a("li",{children:"Drag with the mouse to create a selection"}),C("li",{children:["Hold ",a("code",{children:"Ctrl"})," before selecting a region to invert it"]})]})})]})},Te=()=>{const[n,e]=y.exports.useState(!1);return C(K,{children:[a(De,{}),a("div",{style:{display:"grid",gap:16},children:a(Ae,{onDelete:()=>e(!0)})}),a("div",{children:a(Oe,{})}),a(Le,{isModalOpen:n,onClose:()=>e(!1)})]})},Ye=n=>{const e=y.exports.useRef(),[o,r]=y.exports.useState(!0),[s,t]=y.exports.useState(void 0),[p,f]=y.exports.useState([]),[S,b]=y.exports.useState(1),[i,_]=y.exports.useState(!0),[E,k]=y.exports.useState([]),[v,u]=y.exports.useState(4),d=y.exports.useRef(),l=y.exports.useMemo(()=>i?E.map(({region:c})=>ae(c,v)):[],[i,v,E]);d.current={mapData:p,selectionInfo:s,excludedRegions:l};const h=y.exports.useMemo(()=>({deleteMapData:()=>{if(!d.current)throw new Error("Something went wrong!");const{excludedRegions:c,mapData:g,selectionInfo:M}=d.current;if(!e.current)return console.error("No directory handle found! Cannot delete map files!"),[g,Promise.resolve()];if(!M)return[g,Promise.resolve()];const[B,L]=Ee(e.current,g,M.selection,M.isSelectionInverted,c);L.then(()=>{f(B)})},loadMapData:async()=>{e.current=await window.showDirectoryPicker();const c=await _e(e.current),g=await Be(e.current).catch(M=>(console.error("Failed to load safe houses! Please raise an issue on Please raise an issue at https://github.com/grabofus/zomboid-chunk-cleaner/issues",M),[]));f(c),k(g)},selectRegion:(c,g)=>{t({selection:c,isSelectionInverted:g!=null?g:!1})},unselectRegion:()=>{t(void 0)},setIsSafeHouseProtectionEnabled:c=>{_(c)},setSafeHousePadding:c=>{u(c)},setZoomLevel:c=>{b(c)},toggleMap:c=>{r(c)}}),[]);y.exports.useEffect(()=>{!!e.current},[]);const x=y.exports.useMemo(()=>{var c;return{excludedRegions:l,isMapDisplayed:o,isSafeHouseProtectionEnabled:i,isSelectionInverted:(c=s==null?void 0:s.isSelectionInverted)!=null?c:!1,mapData:p,safeHouses:E,safeHousePadding:v,selection:s==null?void 0:s.selection,zoomLevel:S}},[o,i,p,v,E,s,S]),R=y.exports.useMemo(()=>({actions:h,state:x}),[h,x]);return a(re.Provider,{value:R,children:n.children})};const Xe=we({palette:{mode:"dark",background:{default:"#000"}}});Me.render(a(Se.StrictMode,{children:a(Ye,{children:a(Ie,{theme:Xe,children:C(K,{children:[a(ke,{}),a(Te,{})]})})})}),document.getElementById("root"));
